<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRANTOP • Finanças</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #0f172a; color: #f8fafc; }
    .card { border:1px solid #1e293b; border-radius:14px; background:#1e293b; padding:1rem; }
    .hidden { display:none; }
  </style>
  <script>
    // >>> CONFIG
    const API_URL = "https://script.google.com/macros/s/AKfycbxNnImMbyHsNJqroWJVZUlZifceriiwOBlB6Ra9zs545DtrrwNh3ng8GnhCaI_TZ1Yngw/exec"; // substitua pela URL /exec da implantação
    const TOKEN   = "2400";

    async function apiGet(params = {}) {
      const usp = new URLSearchParams({ token: TOKEN, ...params });
      const url = `${API_URL}?${usp.toString()}`;
      const res = await fetch(url, { method: "GET" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function apiPost(data = {}) {
      const fd = new FormData();
      fd.append("token", TOKEN);
      for (const [k,v] of Object.entries(data)) fd.append(k, v);
      const res = await fetch(API_URL, { method:"POST", body: fd });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function checarConexao() {
      const alerta = document.getElementById("alertaApi");
      try {
        const pong = await apiGet({ action: "ping" });
        console.log("API OK:", pong);
        alerta.classList.add("hidden");
      } catch (e) {
        console.error("Erro API:", e);
        alerta.textContent = "Falha ao conectar. Verifique API_URL (/exec), acesso público e TOKEN.";
        alerta.classList.remove("hidden");
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      checarConexao();
    });
  </script>
</head>
<body class="p-4">
  <header class="mb-4 flex items-center justify-between">
    <h1 class="text-xl font-bold">GRANTOP • Finanças</h1>
    <button onclick="checarConexao()" class="px-3 py-1 bg-blue-600 rounded">Recarregar</button>
  </header>

  <div id="alertaApi" class="hidden text-red-500 font-bold mb-4"></div>

  <main class="space-y-4">
    <section class="card">
      <h2 class="font-semibold mb-2">Funcionários</h2>
      <form id="formFunc" onsubmit="salvarFuncionario(event)">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
          <input class="p-2 rounded bg-slate-800" name="funcionario" placeholder="Funcionário" />
          <input class="p-2 rounded bg-slate-800" name="salario" placeholder="Salário (R$)" type="number" />
          <input class="p-2 rounded bg-slate-800" name="percAdicional" placeholder="% Adicional" type="number" />
          <input class="p-2 rounded bg-slate-800" name="diarias" placeholder="Diárias (qtd)" type="number" />
          <input class="p-2 rounded bg-slate-800" name="valorDiaria" placeholder="Valor da diária (R$)" type="number" />
          <input class="p-2 rounded bg-slate-800" name="vt" placeholder="VT (R$)" type="number" />
          <input class="p-2 rounded bg-slate-800" name="vr" placeholder="VR (R$)" type="number" />
          <input class="p-2 rounded bg-slate-800" name="descontos" placeholder="Descontos (R$)" type="number" />
        </div>
        <div class="mt-3 flex gap-2">
          <button class="px-3 py-1 bg-green-600 rounded" type="submit">Salvar</button>
          <button class="px-3 py-1 bg-gray-600 rounded" type="reset">Limpar</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2 class="font-semibold mb-2">Registros</h2>
      <table class="w-full text-sm border-collapse">
        <thead>
          <tr class="text-left border-b border-slate-600">
            <th>ID</th><th>Funcionário</th><th>Salário</th><th>VT</th><th>VR</th><th>Total</th><th>Atualizado</th>
          </tr>
        </thead>
        <tbody id="tbodyRegistros"></tbody>
      </table>
    </section>
  </main>

  <script>
    async function salvarFuncionario(ev) {
      ev.preventDefault();
      const fd = new FormData(ev.target);
      const data = Object.fromEntries(fd.entries());
      data.action = "add";
      try {
        const res = await apiPost(data);
        console.log("Salvo:", res);
        alert("Registro salvo com sucesso!");
      } catch (e) {
        alert("Erro ao salvar: " + e.message);
      }
    }
  </script>
</body>
</html>
